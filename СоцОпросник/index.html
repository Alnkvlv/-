<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥–º–∏–Ω ‚Äî –°–æ—Ü–û–ø—Ä–æ—Å–Ω–∏–∫</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 20px; }
    .container { max-width: 900px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: auto; }
    h1, h2 { text-align: center; color: #ff6600; }
    label { display: block; margin: 15px 0 5px; }
    input[type="text"], select, textarea {
      width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; resize: vertical;
    }
    input[type="submit"], button {
      background-color: #ff6600; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px;
    }
    input[type="submit"]:hover, button:hover { background-color: #e65c00; }
    #chart-container, #qrcode { margin-top: 40px; text-align: center; }
    canvas { margin: 20px auto; }

    /* –õ–æ–≥–æ—Ç–∏–ø */
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 150px;
      height: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" class="logo" />
    <h1>–°–æ—Ü–û–ø—Ä–æ—Å–Ω–∏–∫ ‚Äî –ê–¥–º–∏–Ω</h1>

    <div id="qrcode"></div>

    <h2>–°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞</h2>
    <form id="questionBuilder">
      <label for="questionText">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
      <input type="text" id="questionText" required>

      <label for="questionType">–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞:</label>
      <select id="questionType">
        <option value="text">–û—Ç–∫—Ä—ã—Ç—ã–π (—Ç–µ–∫—Å—Ç)</option>
        <option value="choice">–û–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä</option>
        <option value="likert">–®–∫–∞–ª–∞ –õ–∞–π–∫–µ—Ä—Ç–∞ (1-5)</option>
      </select>

      <div id="choiceOptions" style="display: none;">
        <label>–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
        <input type="text" id="choices">
      </div>

      <button type="button" onclick="addQuestion()">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
      <button type="button" onclick="saveSurvey()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–ø—Ä–æ—Å</button>
      <button type="button" onclick="clearSurvey()">üóë –û—á–∏—Å—Ç–∏—Ç—å –æ–ø—Ä–æ—Å</button>
    </form>

    <div id="chart-container">
      <div>
        <h3>–í–æ–∑—Ä–∞—Å—Ç —Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç–æ–≤</h3>
        <canvas id="ageChart" width="400" height="300"></canvas>
      </div>
      <div>
        <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–æ–ª—É</h3>
        <canvas id="genderChart" width="400" height="300"></canvas>
      </div>
    </div>

    <div id="result"></div>
  </div>

  <script>
    const surveyStructure = JSON.parse(localStorage.getItem('surveyStructure')) || [];
    const allResponses = JSON.parse(localStorage.getItem('surveyResponses')) || [];

    function addQuestion() {
      const qText = document.getElementById('questionText').value.trim();
      const qType = document.getElementById('questionType').value;
      const qChoices = document.getElementById('choices').value.trim();
      if (!qText) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞!');
        return;
      }
      const question = { text: qText, type: qType, choices: qChoices };
      surveyStructure.push(question);
      saveSurvey();
      document.getElementById('questionBuilder').reset();
      document.getElementById('choiceOptions').style.display = 'none';
      alert('–í–æ–ø—Ä–æ—Å –¥–æ–±–∞–≤–ª–µ–Ω');
      renderResults(); // –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    }

    function saveSurvey() {
      localStorage.setItem('surveyStructure', JSON.stringify(surveyStructure));
    }

    function clearSurvey() {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –æ–ø—Ä–æ—Å –∏ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã?')) {
        localStorage.removeItem('surveyStructure');
        localStorage.removeItem('surveyResponses');
        location.reload();
      }
    }

    document.getElementById('questionType').addEventListener('change', function () {
      document.getElementById('choiceOptions').style.display = this.value === 'choice' ? 'block' : 'none';
    });

    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–æ–≤ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º
    function groupAges(responses) {
      const ageGroups = {
        '0-9': 0,
        '10-19': 0,
        '20-29': 0,
        '30-39': 0,
        '40-49': 0,
        '50-59': 0,
        '60+': 0
      };

      responses.forEach(resp => {
        const ageStr = resp['–í–æ–∑—Ä–∞—Å—Ç'];
        if (!ageStr) return;
        const age = parseInt(ageStr, 10);
        if (isNaN(age)) return;

        if (age < 10) ageGroups['0-9']++;
        else if (age < 20) ageGroups['10-19']++;
        else if (age < 30) ageGroups['20-29']++;
        else if (age < 40) ageGroups['30-39']++;
        else if (age < 50) ageGroups['40-49']++;
        else if (age < 60) ageGroups['50-59']++;
        else ageGroups['60+']++;
      });

      return ageGroups;
    }

    // –ü–æ–¥—Å—á–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –ø–æ–ª—É
    function countGenders(responses) {
      const genders = { '–º—É–∂': 0, '–∂–µ–Ω': 0, '–¥—Ä—É–≥–æ–µ': 0, '–ù–µ —É–∫–∞–∑–∞–Ω–æ': 0 };
      responses.forEach(resp => {
        const gender = resp['–ü–æ–ª'] ? resp['–ü–æ–ª'].toLowerCase() : '';
        if (gender === '–º—É–∂' || gender === '–º') genders['–º—É–∂']++;
        else if (gender === '–∂–µ–Ω' || gender === '–∂') genders['–∂–µ–Ω']++;
        else if (gender === '–¥—Ä—É–≥–æ–µ') genders['–¥—Ä—É–≥–æ–µ']++;
        else genders['–ù–µ —É–∫–∞–∑–∞–Ω–æ']++;
      });
      return genders;
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–∏–∞–≥—Ä–∞–º–º
    function renderResults() {
      // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      if (window.ageChartInstance) {
        window.ageChartInstance.destroy();
      }
      if (window.genderChartInstance) {
        window.genderChartInstance.destroy();
      }

      const ageGroups = groupAges(allResponses);
      const genders = countGenders(allResponses);

      const ctxAge = document.getElementById('ageChart').getContext('2d');
      window.ageChartInstance = new Chart(ctxAge, {
        type: 'bar',
        data: {
          labels: Object.keys(ageGroups),
          datasets: [{
            label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç–æ–≤',
            data: Object.values(ageGroups),
            backgroundColor: '#ff6600'
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, precision: 0 }
          }
        }
      });

      const ctxGender = document.getElementById('genderChart').getContext('2d');
      window.genderChartInstance = new Chart(ctxGender, {
        type: 'pie',
        data: {
          labels: Object.keys(genders),
          datasets: [{
            data: Object.values(genders),
            backgroundColor: ['#3399ff', '#ff6699', '#999999', '#cccccc']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { enabled: true }
          }
        }
      });

      // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã
      let html = '<h3>–í—Å–µ –æ—Ç–≤–µ—Ç—ã:</h3>';
      allResponses.forEach((r, i) => {
        html += `<strong>–û—Ç–≤–µ—Ç #${i + 1}</strong><br>`;
        for (let key in r) {
          html += `${key}: ${r[key]}<br>`;
        }
        html += '<br>';
      });
      document.getElementById('result').innerHTML = html;
    }

    renderResults();

    new QRCode(document.getElementById("qrcode"), {
      text: window.location.origin + "/survey.html",
      width: 128,
      height: 128,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
  </script>
</body>
</html>
